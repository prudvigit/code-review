@AbapCatalog.sqlViewName: 'ZV_BI_NOL'
@AbapCatalog.compiler.compareFilter: true
@AbapCatalog.preserveKey: true
@AccessControl.authorizationCheck: #CHECK
@EndUserText.label: 'BI NOL Extended View'

define view zcv_p2m_bi_nol
  as select from    mara
    inner join      makt on  mara.matnr = makt.matnr
                         and makt.spras = $session.system_language
    inner join      marc on marc.matnr = mara.matnr
    left outer join eord on  eord.matnr = mara.matnr
                         and eord.werks = marc.werks
    left outer join qinf on  qinf.matnr = mara.matnr
                         and qinf.werk  = marc.werks
    left outer join mapl on  mapl.matnr = mara.matnr
                         and mapl.werks = marc.werks
    left outer join mkal on  mkal.matnr = mara.matnr
                         and mkal.werks = marc.werks
                         
 -- Joins for contract lead time logic
  left outer join ekpo as ekpo_vendor on ekpo_vendor.ebeln = eord.flifn and ekpo_vendor.matnr = mara.matnr and ekpo_vendor.werks = marc.werks
  left outer join ekpo as ekpo_agreement on ekpo_agreement.ebeln = eord.febel and ekpo_agreement.matnr = mara.matnr and ekpo_agreement.werks = marc.werks
    and mkal.werks = marc.werks
    
  // Joins for vendor info record check
    left outer join eina on  eina.lifnr = eord.lifnr
                         and eina.matnr = mara.matnr
    left outer join eine on  eine.infnr = eina.infnr
                         and eine.werks = marc.werks

{
  mara.matnr      as MaterialNumber,                // Material Number
  makt.maktx      as MaterialDescription,           // Material Description
  mara.matkl      as MaterialGroup,                 // Material Group
  marc.schgt      as BulkIndicator,                 // Bulk Material Indicator
  mara.mtart      as MaterialType,                  // Material Type
  marc.rgekz      as BackflushIndicator,            // Backflush Indicator
  marc.sfcpf      as SchedulingProfile,             // Scheduling Profile
  mara.xchpf      as BatchManagement,               // Batch Management Indicator
  marc.werks      as Plant,                         // Plant
  marc.zzprodcode as ProductCode,                   // Custom Product Code
  mara.ersda      as CreatedOn,                     // Material Creation Date
  mara.meins      as BaseUnit,                      // Base Unit of Measure
  marc.mmsta      as MMStatus,                      // Plant-Specific Material Status
  mara.mstae      as CrossPlantStatus,              // Cross-Plant Material Status
  marc.beskz      as ProcurementType,               // Procurement Type
  marc.disgr      as MRPGroup,                      // MRP Group
  marc.dismm      as MRPType,                       // MRP Type
  marc.dispo      as MRPController,                 // MRP Controller
  marc.ekgrp      as PurchasingGroup,               // Purchasing Group
  marc.plifz      as PlannedDeliveryTime,           // Planned Delivery Time
  marc.sobsl      as SpecialProcurementType,        // Special Procurement Type
  marc.webaz      as GRProcessingTime,              // GR Processing Time in Days
  marc.minbe      as MinimumLotSize,                // Minimum Lot Size
  marc.bstmi      as FixedLotSize,                  // Fixed Lot Size Min
  marc.bstma      as FixedLotSizeMax,               // Fixed Lot Size Max
  marc.wzeit      as InHouseProductionTime,         // In-House Production Time
  mara.raube      as StorageConditions,             // Storage Conditions
  mara.qmpur      as QMInProcurement,               // QM in Procurement
  marc.disls      as LotSizeProcedure,              // Lot Size Procedure
  marc.sbdkz      as IndividualCollectiveIndicator, // Individual/Collective Indicator
  marc.strgr      as StrategyGroup,                 // Strategy Group
  marc.ssqss      as QuotaArrangementUsage,         // Quota Arrangement Usage
  marc.vrmod      as ConsumptionMode,               // Consumption Mode
  marc.vint1      as ForwardConsumptionPeriod,      // Forward Consumption Period
  marc.vint2      as BackwardConsumptionPeriod,     // Backward Consumption Period
  marc.bstrf      as PlanningStrategyIndicator,     // Planning Strategy Indicator
  marc.fvidk      as ForecastIndicator,             // Forecast Indicator
  mara.ntgew      as NetWeight,                     // Net Weight
  mara.gewei      as WeightUnit,                    // Unit of Weight
  marc.dzeit      as SchedulingMarginKey,           // Scheduling Margin Key
  marc.mabst      as AvailabilityCheck,             // Availability Check Indicator
  marc.lgfsb      as IssueStorageLocation,          // Issue Storage Location
  marc.lgpro      as ProductionStorageLocation,     // Production Storage Location

  eord.lifnr      as SourceListVendor,              // Source List Vendor
  eord.flifn      as FixedVendor,                   // Fixed Vendor in Source List
  eord.febel      as DeliveryBlock,                 // Delivery Block in Source List
  eord.vrtyp      as ProcurementTypeSourceList,     // Procurement Type (Source List)


  // PIR Indicator Flag: Y if FLIFN exists and EINA/EINE entries exist; '#' if no FLIFN; N if FLIFN exists but no entries
  case
    when eord.flifn <> '' and eina.infnr is not null and eine.infnr is not null then 'Y'
    when eord.flifn = '' then '#'
    when eord.flifn <> '' and (eina.infnr is null or eine.infnr is null) then 'N'
    else ''
  end             as PirIndicatorFlag,


  // Quality Fixed Vendor Flag: Y/#/N
  case
    when eord.flifn <> '' and qinf.lieferant = eord.lifnr and qinf.revlv = '01' then 'Y'
    when eord.flifn = '' then '#'
    when eord.flifn <> '' and not (qinf.lieferant = eord.lifnr and qinf.revlv = '01') then 'N'
    else ''
  end             as QualityFixedVendorFlag,

  qinf.lieferant  as QInfoRecordVendor,         // Quality Info Record Vendor
  qinf.werk       as QInfoPlant,                // Plant in Quality Info Record
  qinf.loekz      as QInfoDeletionFlag,         // Deletion Flag in QInfo Record

  mapl.werks      as MaplPlant,                 // Plant for Task List Assignment
  mapl.plnty      as TaskListType,              // Task List Type
  mapl.loekz      as MaplDeletionFlag,          // Deletion Indicator (MAPL)

  mkal.werks      as MkalPlant,                 // Plant in Production Version
  mkal.matnr      as MkalMaterial,              // Material in Production Version
  mkal.verid      as ProductionVersion,         // Production Version
  mkal.elpro      as ExplosionIndicator,        // Explosion Indicator
  mkal.alort      as IssueStorageLocationPV,    // Issue Storage Location in PV
  mkal.text1      as ProductionVersionText,     // Description in Production Version
  mkal.stlal      as BOMAlternative,            // BOM Alternative
  mkal.alnal      as RoutingAlternative,        // Routing Alternative

  // Bulk material rule: X if type = ZPRR
  case
    when mara.mtart = 'ZPRR' then 'X'
    else ''
  end             as schgt_rule, // Rule: BulkIndicator by MaterialType

  // Bulk error: if BulkIndicator manually X but type <> ZPRR
  case
    when marc.schgt = 'X' and mara.mtart <> 'ZPRR'
      then 'Error: BULK'
    else ''
  end             as bulk_error, // Error if inconsistent bulk setting

  // Backflush Rule Logic
  case
    when marc.sfcpf = 'Z00001' and mara.xchpf <> 'X' then 'X'
    else ''
  end             as backflush_check, // Rule: Backflush allowed

  case
    when marc.sfcpf = 'Z00001' and mara.xchpf = 'X' then 'Error: BACKFLUSH'
    else ''
  end             as backflush_error,  // Error if batch managed and schedule profile = Z00001
  
  // Contract Lead Time: EKPO.PLIFZ based on fixed vendor or agreement
  case
    when ( eord.flifn <> '' or eord.febel <> '' ) and eord.vrtyp = 'K' then
      case when eord.flifn <> '' then ekpo_vendor.plifz else ekpo_agreement.plifz end
    else ''
  end as ContractLeadTime,
  
  // Calculated MRP Type per business rules
  case
    when marc.werks = '7165' and ( mara.matnr like '71%' or mara.matnr like '06%' ) then 'VB'
    when marc.werks = '7165' and ( mara.mtart = 'ZFRT' or mara.mtart = 'ZHAB' or mara.mtart = 'ZROH' ) then 'PD'
    when marc.werks = '7165' and mara.mtart = 'ZUNB' then 'VB'
    when marc.werks = '7165' and mara.mtart = 'ZSRV' then ''
    when marc.werks = '7165' and mara.mtart = 'ZRSA' then 'ND'
    when marc.werks = '7165' and ( mara.mtart = 'ZERP' or mara.mtart = 'ZPRR' or mara.mtart = 'ZPRA' )  then 'PD'
    when marc.werks = '7165' and ( mara.mtart = 'ZERP' or mara.mtart = 'ZPRR' or mara.mtart = 'ZPRA' )  then 'VB'
    when marc.werks = '7165' and ( mara.mtart = 'ZRSA' or mara.mtart = 'ZSRV' or mara.mtart = 'ZPRA' or mara.mtart = 'ZPRR' ) then 'ND'
    when marc.werks <> '7165' and marc.werks <> '7110' and ( mara.mtart = 'ZFRT' or mara.mtart = 'ZHAB' or mara.mtart = 'ZROH' or mara.mtart = 'ZERP' ) then 'PD'
    when marc.werks <> '7165' and marc.werks <> '7110' and mara.mtart = 'ZUNB' then 'VB'
    when marc.werks <> '7165' and marc.werks <> '7110' and ( mara.mtart = 'ZRSA' or mara.mtart = 'ZSRV' or mara.mtart = 'ZPRA' or mara.mtart = 'ZPRR' ) then 'ND'
    else 'Error: MRPTYPE'
  end as CalculatedMRPType

}
