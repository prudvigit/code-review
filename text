@AbapCatalog.sqlViewName: 'ZV_MAT_EXTENDED'
@AbapCatalog.compiler.compareFilter: true
@AccessControl.authorizationCheck: #NOT_REQUIRED
@EndUserText.label: 'Extended Material Master View'

define view Z_CDS_MAT_EXTENDED as select from mara
  inner join makt on mara.matnr = makt.matnr and makt.spras = $session.system_language
  inner join marc as marc_comp on marc_comp.matnr = mara.matnr
  left outer join eord on eord.matnr = mara.matnr and eord.werks = marc_comp.werks
  left outer join qinf on qinf.matnr = mara.matnr and qinf.werks = marc_comp.werks
  left outer join mapl on mapl.matnr = mara.matnr and mapl.werks = marc_comp.werks
  left outer join mkal on mkal.matnr = mara.matnr and mkal.werks = marc_comp.werks
  left outer join stpo on stpo.idnrk = mara.matnr
  left outer join stko on stko.stlnr = stpo.stlnr
  left outer join marc as marc_header on marc_header.matnr = stko.matnr and marc_header.werks = marc_comp.werks
{
  mara.matnr as MaterialNumber,                      // Material Number
  makt.maktx as MaterialDescription,                 // Material Description
  mara.matkl as MaterialGroup,                       // Material Group
  marc_comp.schgt as BulkIndicator,                  // Bulk Material Indicator
  mara.mtart as MaterialType,                        // Material Type
  marc_comp.rgekz as BackflushIndicator,             // Backflush Indicator
  marc_comp.sfcpf as SchedulingProfile,              // Scheduling Profile
  mara.xchpf as BatchManagement,                     // Batch Management Indicator
  marc_comp.werks as Plant,                          // Plant
  marc_comp.zzprodcode as ProductCode,               // Custom Product Code
  mara.ersda as CreatedOn,                           // Material Creation Date
  marc_comp.ersda as MarcCreatedOn,                  // Plant Data Created On
  mara.meins as BaseUnit,                            // Base Unit of Measure
  marc_comp.mmsta as MMStatus,                       // Plant-Specific Material Status
  mara.mstae as CrossPlantStatus,                    // Cross-Plant Material Status
  marc_comp.beskz as ProcurementType,                // Procurement Type
  marc_comp.disgr as MRPGroup,                       // MRP Group
  marc_comp.dismm as MRPType,                        // MRP Type
  marc_comp.dispo as MRPController,                  // MRP Controller
  marc_comp.ekgrp as PurchasingGroup,                // Purchasing Group
  marc_comp.plifz as PlannedDeliveryTime,            // Planned Delivery Time
  marc_comp.sobsl as SpecialProcurementType,         // Special Procurement Type
  marc_comp.webaz as GRProcessingTime,               // GR Processing Time in Days
  marc_comp.minbe as MinimumLotSize,                 // Minimum Lot Size
  marc_comp.bstmi as FixedLotSize,                   // Fixed Lot Size Min
  marc_comp.bstma as FixedLotSizeMax,                // Fixed Lot Size Max
  marc_comp.wzeit as InHouseProductionTime,          // In-House Production Time
  mara.raube as StorageConditions,                   // Storage Conditions
  mara.qmpur as QMInProcurement,                     // QM in Procurement
  marc_comp.disls as LotSizeProcedure,               // Lot Size Procedure
  marc_comp.sbdkz as IndividualCollectiveIndicator,  // Individual/Collective Indicator
  marc_comp.strgr as StrategyGroup,                  // Strategy Group
  marc_comp.ssqss as QuotaArrangementUsage,          // Quota Arrangement Usage
  marc_comp.vrmod as ConsumptionMode,                // Consumption Mode
  marc_comp.vint1 as ForwardConsumptionPeriod,       // Forward Consumption Period
  marc_comp.vint2 as BackwardConsumptionPeriod,      // Backward Consumption Period
  marc_comp.bstrf as PlanningStrategyIndicator,      // Planning Strategy Indicator
  marc_comp.fvidk as ForecastIndicator,              // Forecast Indicator
  mara.ntgew as NetWeight,                           // Net Weight
  mara.gewei as WeightUnit,                          // Unit of Weight
  marc_comp.dzeit as SchedulingMarginKey,            // Scheduling Margin Key
  marc_comp.mabst as AvailabilityCheck,              // Availability Check Indicator
  marc_comp.lgfsb as IssueStorageLocation,           // Issue Storage Location
  marc_comp.lgpro as ProductionStorageLocation,      // Production Storage Location

  eord.lifnr as SourceListVendor,                    // Source List Vendor
  eord.flifn as FixedVendor,                         // Fixed Vendor in Source List
  eord.febel as DeliveryBlock,                       // Delivery Block in Source List
  eord.vrtyp as ProcurementTypeSourceList,           // Procurement Type (Source List)

  qinf.lieferant as QInfoRecordVendor,               // Quality Info Record Vendor
  qinf.werks as QInfoPlant,                          // Plant in Quality Info Record
  qinf.loekz as QInfoDeletionFlag,                   // Deletion Flag in QInfo Record

  mapl.werks as MaplPlant,                           // Plant for Task List Assignment
  mapl.plnty as TaskListType,                        // Task List Type
  mapl.loekz as MaplDeletionFlag,                    // Deletion Indicator (MAPL)

  mkal.werks as MkalPlant,                           // Plant in Production Version
  mkal.matnr as MkalMaterial,                        // Material in Production Version
  mkal.verid as ProductionVersion,                   // Production Version
  mkal.elpro as ExplosionIndicator,                  // Explosion Indicator
  mkal.alort as IssueStorageLocationPV,              // Issue Storage Location in PV
  mkal.text1 as ProductionVersionText,               // Description in Production Version
  mkal.stlal as BOMAlternative,                      // BOM Alternative
  mkal.alnal as RoutingAlternative,                  // Routing Alternative

  case
    when mara.mtart = 'ZPRR' then 'X'
    else ''
  end as schgt_rule,                                 // Rule: Mark as bulk if material type = ZPRR

  case
    when marc_header.sfcpf = 'Z00001' and mara.xchpf <> 'X' then 'X'
    else ''
  end as backflush_check,                            // Rule: Backflush allowed if header schedule profile = Z00001 and not batch managed

  case
    when marc_header.sfcpf = 'Z00001' and mara.xchpf = 'X' then 'Error: BACKFLUSH'
    else ''
  end as backflush_error                             // Error if batch managed and schedule profile = Z00001

} 
